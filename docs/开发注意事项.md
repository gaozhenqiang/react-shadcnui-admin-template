# 开发注意事项

本文档记录项目开发过程中需要注意的通用规范和最佳实践。

---

## 1. API 字段名必须与后端文档一致

### 要求

前端定义的字段名必须与后端 API 文档完全一致，否则接口调用会报错。

### 操作步骤

1. 开发新功能前，先查看 `public/育安教育项目.openapi.json` 确认字段名
2. 在 `types.ts` 中定义类型时严格按照 API 文档
3. 表单字段、表格列等都要使用正确的字段名

---

## 2. 表格排序字段规范

### 要求

1. **表格必须显示排序字段**（如果 API 支持）
2. **排序列放在表格最前面**
3. **列名统一为"排序"**，不要使用"序号"等其他名称

### 示例代码

```typescript
export const columns: ColumnDef<Item>[] = [
  {
    accessorKey: 'order',
    header: '排序',
    cell: ({ row }) => (
      <div className='text-muted-foreground'>{row.getValue('order') ?? 0}</div>
    ),
    enableSorting: false,
    meta: {
      className: 'w-[60px]',
    },
  },
  // ... 其他列
]
```

---

## 3. 新增数据时排序字段自动累加

### 需求

新增数据时，排序字段默认值应为 **当前数据总数 + 1**，实现自动累加。

### 实现方案

1. **在 Provider 中添加 count 状态**

```typescript
type ContextType = {
  // ... 其他属性
  itemsCount: number
  setItemsCount: React.Dispatch<React.SetStateAction<number>>
}

export function Provider({ children }) {
  const [itemsCount, setItemsCount] = useState(0)
  // ...
  return (
    <Context value={{ ..., itemsCount, setItemsCount }}>
      {children}
    </Context>
  )
}
```

2. **在 Table 组件中更新 count**

```typescript
export function ItemsTable() {
  const { setItemsCount } = useItems()
  
  useEffect(() => {
    fetchData().then((res) => {
      setData(res.list || [])
      setItemsCount(res.total || res.list?.length || 0)
    })
  }, [])
}
```

3. **在 Dialog 中使用 count 设置默认值**

```typescript
export function ActionDialog() {
  const { itemsCount } = useItems()
  
  const form = useForm({
    defaultValues: isEdit
      ? { ...currentRow }
      : {
          order: itemsCount + 1, // 默认排序为当前总数+1
        },
  })
}
```

---

## 4. 表格列显示持久化

### 说明

表格的列显示/隐藏设置需要持久化保存，刷新页面后保持用户设置。

### 实现

使用 `useTableSettingsStore`（基于 Zustand + IndexedDB）存储每个表格的列显示设置。

```typescript
const TABLE_KEY = 'unique-table-key' // 每个表格唯一标识

const { _hasHydrated, getColumnVisibility, setColumnVisibility } = useTableSettingsStore()

// 等待 hydration 完成后初始化
useEffect(() => {
  if (_hasHydrated) {
    setColumnVisibility(getColumnVisibility(TABLE_KEY))
  }
}, [_hasHydrated])

// 列显示变化时保存
onColumnVisibilityChange: (updater) => {
  const newVisibility = typeof updater === 'function' ? updater(columnVisibility) : updater
  setColumnVisibility(newVisibility)
  saveColumnVisibility(TABLE_KEY, newVisibility)
}
```

---

## 5. 媒体预览组件注意事项

### 图片/封面可选渲染

表格中的图片字段通常是可选的，需要条件渲染：

```typescript
cell: ({ row }) => (
  <div className='flex items-center gap-3'>
    {row.original.coverUrl && (
      <MediaPreview
        src={row.original.coverUrl}
        alt={row.getValue('name')}
        type='image'
        width={64}
        height={40}
      />
    )}
    <div className='font-medium'>{row.getValue('name')}</div>
  </div>
)
```

### 关闭按钮去重

`MediaPreview` 组件内部有自定义关闭按钮，`DialogContent` 需设置 `showCloseButton={false}`。

---

## 6. 选择器组件宽度

### 问题

选择器在选择数据后宽度可能变小。

### 解决方案

使用固定宽度而不是 `max-w-*`：

```tsx
// ❌ 错误
<div className='max-w-sm'>
  <Selector ... />
</div>

// ✅ 正确
<div className='w-80'>
  <Selector ... />
</div>
```

---

## 7. 页面间跳转与筛选

### 需求

支持从一个列表跳转到关联页面并自动应用筛选条件。

### 实现

1. **定义路由 search schema**

```typescript
const searchSchema = z.object({
  parentId: z.string().optional(),
})
```

2. **添加跳转链接**

```typescript
<DropdownMenuItem asChild>
  <Link to='/target/page' search={{ parentId: row._id }}>
    <Icon className='mr-2 h-4 w-4' />
    查看详情
  </Link>
</DropdownMenuItem>
```

3. **在目标页面读取并应用筛选**

```typescript
const search = route.useSearch()
const parentId = search.parentId as string | undefined
```

---

## 8. 文件上传注意事项

### 视频时长自动识别

使用 `FileUpload` 组件上传视频时，会自动识别视频时长并通过 `onSuccess` 回调返回：

```typescript
<FileUpload
  accept={['.mp4', '.webm', '.mov']}
  getUploadUrl={getUploadUrl}
  onSuccess={(info) => {
    form.setValue('mediaUrl', info.fileUrl)
    if (info.duration !== undefined) {
      form.setValue('durationInSeconds', info.duration)
    }
  }}
/>
```

### 时长字段只读

视频时长应该是自动识别的，不允许用户手动输入：

```typescript
<Input
  readOnly
  value={duration ? formatDuration(duration) : '上传视频后自动识别'}
  className='bg-muted'
/>
```

---

## 9. 参考模块

开发新模块时，可参考以下已完成的模块结构：

- `src/features/enroll/projects` - 报考项目管理
- `src/features/course/courses` - 课程管理
- `src/features/course/lessons` - 课时管理

---

## 10. 常用组件

详细文档请查看 `src/components/README.md`

| 组件 | 说明 |
|------|------|
| `FileUpload` | 文件上传（支持视频时长自动识别） |
| `MediaPreview` | 媒体预览（图片/视频） |
| `ProjectSelector` | 报考项目选择器（远程搜索） |
| `CourseSelector` | 课程选择器（远程搜索） |
| `DataTableToolbar` | 表格工具栏（搜索、筛选） |
| `DataTableViewOptions` | 列显示设置 |
| `DataTablePagination` | 分页组件 |


# 注意事项

1. 注意所有的 创建、更新、list，都需要loading状态。